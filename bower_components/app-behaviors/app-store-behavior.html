<html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../expandjs/expandjs.html">
<link rel="import" href="../xp-elements/xp-master-slave-behavior.html">
<link rel="import" href="app-locale-behavior.html">

<script>
    Polymer.APPStoreBehaviorImp = {

        // CLASSES
        classes: ['store'],

        /*********************************************************************/

        /**
         * Should be redefined to setup the application's state.
         *
         * @method initialize
         * @abstract
         */
        initialize() {},

        /*********************************************************************/

        /**
         * Set the application's `memento`.
         *
         * @method memoize
         */
        memoize() {

            // Ensuring
            this.ensure('memento', XP.cloneDeep(this.app));
        },

        /**
         * Resets the application's `state`.
         *
         * @method reset
         */
        reset() {

            // Ensuring
            this.ensure('app', XP.cloneDeep(this.memento));
        },

        /*********************************************************************/

        // LISTENERS
        listeners: {
            'app-route': '__handleRoute'
        },

        // PROPERTIES
        properties: {

            /**
             * The application's state.
             *
             * @attribute app
             * @type Object
             * @notifies
             * @readonly
             */
            app: {
                notify: true,
                readOnly: true,
                type: Object,
                value() { return {}; }
            },

            /**
             * The application's auth.
             *
             * @attribute auth
             * @type Object
             * @notifies
             * @readonly
             */
            auth: {
                notify: true,
                readOnly: true,
                type: Object,
                value() { return {}; }
            },

            /**
             * The application's commands.
             *
             * @attribute commands
             * @type Array
             * @readonly
             */
            commands: {
                readOnly: true,
                slaves: '.command',
                value() { return []; }
            },

            /**
             * If set to true, the store is initialized.
             *
             * @attribute initialized
             * @type boolean
             * @default false
             * @notifies
             * @readonly
             */
            initialized: {
                notify: true,
                readOnly: true,
                reflectToAttribute: true,
                type: Boolean,
                value: false
            },

            /**
             * The application's state's memento.
             *
             * @attribute memento
             * @type Object
             * @readonly
             */
            memento: {
                readOnly: true,
                type: Object
            },

            /**
             * If set to true, the client is offline.
             *
             * @attribute offline
             * @type boolean
             * @notifies
             * @readonly
             */
            offline: {
                notify: true,
                reflectToAttribute: true,
                type: Boolean,
                value: !navigator.onLine
            },

            /**
             * The application's router.
             *
             * @attribute router
             * @type Element
             * @readonly
             */
            router: {
                slave: '.router',
                readOnly: true
            },

            /**
             * The application's shell.
             *
             * @attribute shell
             * @type Element
             * @readonly
             */
            shell: {
                master: '.shell',
                observer: '__shellChanged',
                readOnly: true
            },

            /**
             * The application's sources.
             *
             * @attribute sources
             * @type Object
             * @readonly
             */
            sources: {
                readOnly: true,
                type: Object
            }
        },

        /**
         * The application's namespace.
         *
         * @property namespace
         * @type string
         * @readonly
         */
        get namespace() { return this.shell && this.shell.namespace; },

        /*********************************************************************/

        // OBSERVER
        __shellChanged(post) {

            // Waiting (ShadyDOM)
            this.async(() => {

                // Starting
                this.ensure('initialized', false);

                // Listening
                this[post ? 'listen' : 'unlisten'](window, 'offline', '__handleOffline');
                this[post ? 'listen' : 'unlisten'](window, 'online', '__handleOnline');

                // Checking
                if (!post) { return; }

                // Let
                let locale = XP.toLocale(navigator.language),
                    app    = XP.merge({i18n: {}, locale: locale, meta: {}}, XP.get(window, `app.${this.namespace}`), this.app),
                    auth   = XP.merge(window.auth || {}, this.auth);

                // Ensuring
                this.ensure('app', app);
                this.ensure('auth', auth);

                // Initializing
                this.initialize();

                // Memoizing
                this.memoize();

                // Exposing
                XP.set(window, `app.${this.namespace}`, app);
                XP.set(window, `auth`, auth);

                // Ending
                this.ensure('initialized', true);
            });
        },

        /*********************************************************************/

        // LISTENER
        ready() {

            // Let
            let sources = XP.getElements(Polymer.dom(this.root), '.source[name]:not([name=""])');

            // Ensuring
            this.ensure('sources', sources.reduce((result, source) => { result[source.name] = source; return result; }, {}));
        },

        /*********************************************************************/

        // HANDLER
        __handleOffline() {

            // Ensuring
            this.ensure('offline', true);
        },

        // HANDLER
        __handleOnline() {

            // Ensuring
            this.ensure('online', false);
        },

        // HANDLER
        __handleRoute(event) {

            // Ensuring
            this.async(() => {

                // Preventing
                if (event.defaultPrevented) { return; }

                // Ensuring
                this.ensure('app.route', event.detail.route);
                this.ensure('app.query', event.detail.query);
            });
        }
    };

    Polymer.APPStoreBehavior = [
        Polymer.XPMasterSlaveBehavior,
        Polymer.APPLocaleBehavior,
        Polymer.APPStoreBehaviorImp
    ];
</script>
</head><body></body></html>